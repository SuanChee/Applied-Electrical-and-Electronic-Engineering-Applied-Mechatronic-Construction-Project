#include <LiquidCrystal.h>
#include <Adafruit_MPU6050.h>
#include <Adafruit_Sensor.h>
#include <Wire.h>
#include <math.h>

//motor pins
const int ENA= 11;
const int IN1= 12;
const int IN2= 13;

const int ENB = 3;  
const int IN3 = 2;  
const int IN4 = A2;

//LCD pins
LiquidCrystal lcd(8, 9, 4, 5, 6, 7);

//MPU_6050
Adafruit_MPU6050 mpu;

float angle= 0.0;
int ramp= 0;
int spin= 0;
float totalturnangle= 0.0;
const float targetturn= 360.0;

unsigned long turntimer= 0;
unsigned long angletimer= 0;


void moveforward(){
  analogWrite(ENA, 240);
  analogWrite(ENB, 240);
  digitalWrite(IN1, LOW);
  digitalWrite(IN2, HIGH);
  digitalWrite(IN3, LOW);
  digitalWrite(IN4, HIGH);
}

void turnright(){
  analogWrite(ENA, 230);
  analogWrite(ENB, 125);
  digitalWrite(IN1, LOW);
  digitalWrite(IN2, HIGH);
  digitalWrite(IN3, HIGH);
  digitalWrite(IN4, LOW);
}

void stoprobot(){
  analogWrite(ENA, 0);
  analogWrite(ENB, 0);
  digitalWrite(IN1, LOW);
  digitalWrite(IN2, LOW);
  digitalWrite(IN3, LOW);
  digitalWrite(IN4, LOW);
}


void updateangle(){
  sensors_event_t a, g, temp;
  mpu.getEvent(&a, &g, &temp);
 
  angle = (atan2(a.acceleration.x, sqrt(pow(a.acceleration.y, 2) + pow(a.acceleration.z, 2)))*RAD_TO_DEG)+13.0;
  //Serial.println(String(a.acceleration.x) + " " + String(a.acceleration.y) + " " + String(a.acceleration.z) + " " + String(angle));
}

void updateturnangle() {
  sensors_event_t a, g, temp;
  mpu.getEvent(&a, &g, &temp);

  float turndt = (millis()- turntimer)/ 1000.0;
  turntimer= millis();

  float currentyaw = 2.25* g.gyro.x* RAD_TO_DEG;
  
  // Accumulate the angle turned
  totalturnangle += currentyaw* turndt;
}


void setup() {
  Serial.begin(9600);

  pinMode(ENA, OUTPUT);
  pinMode(ENB, OUTPUT);
  pinMode(IN1, OUTPUT);
  pinMode(IN2, OUTPUT);
  pinMode(IN3, OUTPUT);
  pinMode(IN4, OUTPUT);

  lcd.begin(16, 2);

  Wire.begin();
  if (!mpu.begin()) {  
    lcd.clear();
    lcd.print("MPU Fail");
    while (1) delay(10);
  }
  
  mpu.setAccelerometerRange(MPU6050_RANGE_8_G);
  mpu.setGyroRange(MPU6050_RANGE_500_DEG);

  turntimer = millis();     
  angletimer = millis();  

  ramp= 0;
  spin= 0;
}


void loop() {
  moveforward();
  delay(1000);
  
  while (1){
  
  updateangle();
  
  if (millis() - angletimer >= 150)
  {
    angletimer= millis();
    lcd.clear();
    lcd.setCursor(0,0);

    // Display current angle and state
    lcd.print("Angle: ");
    lcd.print(angle, 1);
    lcd.print(" deg");
 
 if (angle<= 23 && ramp== 0 && spin== 0)
 {
  moveforward();
 }
  
 else if (angle> 23 && ramp== 0 && spin== 0)
  {  
    stoprobot();
    delay(2000);
    
    ramp= 1;
  }
  
  else if (ramp== 1 && spin== 0)
  {
    if (angle >= 3){
      moveforward();
    }
    else{
      stoprobot();
      delay(4000);
      
      spin= 1;
      totalturnangle= 0;
      turntimer= millis();
    }
  }
  else if (spin== 1)
  {
      updateturnangle();
      if (totalturnangle< targetturn)
      {
        turnright();
      }
      else
      {
        stoprobot();
        delay(300);
        spin= 2;
      }
   }
   else if (spin== 2)
   {
      moveforward();
   }
  }  
  }
}
